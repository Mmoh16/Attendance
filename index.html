<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Class Attendance</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <!-- Noto Sans Arabic & Inter Fonts -->
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+Arabic:wght@400;600;700&family=Inter:wght@400;600;700&display=swap" rel="stylesheet">
    
    <style>
        body { 
            font-family: 'Noto Sans Arabic', 'Inter', sans-serif;
        }
    </style>
</head>
<body class="bg-gray-50 min-h-screen flex items-center justify-center p-4">

    <!-- Main Card -->
    <div class="bg-white w-full max-w-md rounded-2xl shadow-xl overflow-hidden border border-gray-100">
        
        <!-- Header (Blue Style) -->
        <div class="bg-blue-600 p-6 text-center">
            <div class="w-16 h-16 bg-white/20 rounded-full flex items-center justify-center mx-auto mb-4 backdrop-blur-sm">
                <i class="fas fa-clipboard-check text-2xl text-white"></i>
            </div>
            <h1 class="text-2xl font-bold text-white mb-1" id="page-headline">Math Session</h1>
            <p class="text-blue-100 text-sm">Please confirm your attendance</p>
        </div>

        <div class="p-6">
            
            <!-- Status Message Container -->
            <div id="status-message" class="hidden mb-4 p-3 rounded-lg text-sm font-medium"></div>

            <!-- Initial View: Attendance Form -->
            <div id="selection-form" class="space-y-4">
                <div id="main-title" class="text-center mb-2">
                    <label for="student-select" class="block text-sm font-medium text-gray-700 mb-2">Select your name</label>
                </div>

                <div class="relative">
                    <select id="student-select" class="block w-full pl-3 pr-10 py-3 text-base border-gray-300 bg-gray-50 border rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-blue-500 sm:text-sm transition-shadow">
                        <option value="" disabled selected>-- Choose Name --</option>
                        <!-- Options injected by JS -->
                    </select>
                    <div class="pointer-events-none absolute inset-y-0 right-0 flex items-center px-2 text-gray-700">
                        <i class="fas fa-chevron-down text-xs"></i>
                    </div>
                </div>

                <!-- Button (Blue Style) -->
                <button id="confirm-btn" class="w-full flex justify-center py-3 px-4 border border-transparent rounded-lg shadow-sm text-sm font-bold text-white bg-blue-600 hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-blue-500 transition-all transform active:scale-95">
                    Confirm Attendance
                </button>
            </div>

            <!-- Success View: Zoom Info (Hidden by default) -->
            <div id="zoom-section" class="hidden text-center space-y-6 animate-fade-in">
                <div class="bg-green-50 text-green-800 p-4 rounded-lg mb-4 border border-green-100">
                    <i class="fas fa-check-circle text-green-500 text-xl mb-2 block"></i>
                    <span class="font-bold">Attendance Logged!</span>
                </div>

                <div class="space-y-4 text-left bg-gray-50 p-5 rounded-xl border border-gray-200">
                    <div>
                        <p class="text-xs text-gray-500 uppercase tracking-wide font-semibold">Zoom ID</p>
                        <div class="flex items-center justify-between mt-1">
                            <span id="zoom-id" class="text-lg font-mono font-bold text-gray-800"></span>
                            <button onclick="copyToClipboard('zoom-id')" class="text-gray-400 hover:text-blue-600 transition-colors"><i class="far fa-copy"></i></button>
                        </div>
                    </div>
                    
                    <div class="border-t border-gray-200 pt-3">
                        <p class="text-xs text-gray-500 uppercase tracking-wide font-semibold">Password</p>
                        <div class="flex items-center justify-between mt-1">
                            <span id="zoom-password" class="text-lg font-mono font-bold text-gray-800"></span>
                            <button onclick="copyToClipboard('zoom-password')" class="text-gray-400 hover:text-blue-600 transition-colors"><i class="far fa-copy"></i></button>
                        </div>
                    </div>
                </div>

                <a id="zoom-link" href="#" target="_blank" class="block w-full py-3 px-4 rounded-lg shadow-md text-sm font-bold text-white bg-blue-500 hover:bg-blue-600 focus:ring-2 focus:ring-offset-2 focus:ring-blue-500 transition-all flex items-center justify-center gap-2">
                    <i class="fas fa-video"></i> Join Zoom Meeting
                </a>
            </div>

        </div>
        
        <!-- Footer -->
        <div class="bg-gray-50 px-6 py-3 border-t border-gray-100 text-center">
            <p class="text-xs text-gray-400">Secure Attendance System</p>
        </div>
    </div>

    <script>
        // --- CONFIGURATION ---
        const ATTENDANCE_WEBHOOK_URL = 'https://api.mark-attendance.com/webhook/log-attendance';

        // --- DYNAMIC DATA INJECTION ---
        // This variable is interpolated by n8n
        const classData = {"meetingId":"no_data_received","studentList":["Error: No Data Received from n8n"],"zoomInfo":{}};

        const zoomInfo = classData.zoomInfo || {};
        const meetingId = classData.meetingId || 'default_session';
        const ATTENDANCE_KEY = 'attendanceTaken_' + meetingId;

        // --- DOM ELEMENTS ---
        const studentSelect = document.getElementById('student-select');
        const confirmBtn = document.getElementById('confirm-btn');
        const zoomSection = document.getElementById('zoom-section');
        const mainTitle = document.getElementById('main-title'); 
        const selectionForm = document.getElementById('selection-form');
        const statusMsg = document.getElementById('status-message');

        // --- HELPER FUNCTIONS ---
        function showMessage(msg, type = 'error') {
            statusMsg.textContent = msg;
            // NOTE: We escaped the backticks and ${} here so they survive into the browser's JS
            statusMsg.className = `mb-4 p-3 rounded-lg text-sm font-medium ${type === 'error' ? 'bg-red-50 text-red-700 border border-red-100' : 'bg-green-50 text-green-700 border border-green-100'}`;
            statusMsg.classList.remove('hidden');
        }

        function copyToClipboard(elementId) {
            const text = document.getElementById(elementId).innerText;
            navigator.clipboard.writeText(text).then(() => {
                const btn = document.querySelector(`button[onclick="copyToClipboard('${elementId}')"]`);
                const originalIcon = btn.innerHTML;
                btn.innerHTML = '<i class="fas fa-check"></i>';
                setTimeout(() => btn.innerHTML = originalIcon, 1500);
            }).catch(err => console.error('Copy failed', err));
        }

        function showZoomInfo() {
            document.getElementById('zoom-id').textContent = zoomInfo.zoomId || 'N/A';
            document.getElementById('zoom-password').textContent = zoomInfo.zoomPassword || 'N/A';
            document.getElementById('zoom-link').href = zoomInfo.zoomLink || '#';
            
            if (selectionForm) selectionForm.style.display = 'none';
            zoomSection.classList.remove('hidden');
            document.getElementById('page-headline').textContent = "Access Granted";
        }

        // --- MAIN LOGIC ---
        document.addEventListener('DOMContentLoaded', () => {
            const attendedName = localStorage.getItem(ATTENDANCE_KEY);
            
            if (attendedName) {
                showZoomInfo();
            } else {
                if (classData.studentList && classData.studentList.length > 0) {
                    classData.studentList.forEach(name => {
                        const option = document.createElement('option');
                        option.value = name;
                        option.textContent = name;
                        studentSelect.appendChild(option);
                    });
                } else {
                    showMessage("No student list found for this session.", "error");
                    confirmBtn.disabled = true;
                    confirmBtn.classList.add('opacity-50', 'cursor-not-allowed');
                }
            }
        });

        confirmBtn.addEventListener('click', async () => {
            const selectedOption = studentSelect.options[studentSelect.selectedIndex];
            
            if (!selectedOption || !selectedOption.value) {
                showMessage("Please select your name from the list.", "error");
                return;
            }

            const studentName = selectedOption.value;
            
            // UI Update: Loading State
            const originalBtnText = confirmBtn.innerHTML;
            confirmBtn.textContent = 'Verifying...';
            confirmBtn.disabled = true;
            confirmBtn.classList.add('opacity-75', 'cursor-wait');
            statusMsg.classList.add('hidden'); 

            try {
                const resp = await fetch(ATTENDANCE_WEBHOOK_URL, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ name: studentName }),
                });

                if (!resp.ok) {
                    throw new Error('Server returned non-OK status');
                }
                
                const respText = await resp.text();
                console.log('Attendance logged:', respText);
                
                localStorage.setItem(ATTENDANCE_KEY, studentName);
                showZoomInfo();

            } catch (err) {
                console.error('Fetch error:', err);
                showMessage('Could not log attendance. Please check connection and try again.', 'error');
                
                confirmBtn.innerHTML = originalBtnText;
                confirmBtn.disabled = false;
                confirmBtn.classList.remove('opacity-75', 'cursor-wait');
            }
        });
    </script>
</body>
</html>